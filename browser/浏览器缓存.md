# 浏览器缓存

### 缓存位置
1. Service Worker
    Service Worker 是运行在浏览器背后的独立线程，一般可以用来实现缓存功能.Service Worker 的缓存与浏览器其他内建的缓存机制不同，它可以让我们自由控制缓存哪些文件、如何匹配缓存、如何读取缓存，并且缓存是持续性的

2. Memory Cache
    内存中的缓存,主要包含的是当前中页面中已经抓取到的资源,例如页面上已经下载的样式、脚本、图片等,一旦关闭 Tab 页面，内存中的缓存也就被释放了

3. Disk Cache
    存储在硬盘中的缓存，读取速度慢点，但是什么都能存储到磁盘中

4. Push Cache
    是 HTTP/2 中的内容，当以上三种缓存都没有命中时，它才会被使用。它只在会话（Session）中存在，一旦会话结束就被释放，并且缓存时间也很短暂 

### 强缓存
不会向服务器发送请求，直接从缓存中读取资源。Network请求返回200状态码，并且Size显示from disk cache或from memory cache。可设置expires 和 cache-control实现强缓存
1. expires
缓存过期时间，用来指定资源到期时间，结合Last-modified使用，在响应http请求时告诉浏览器在过期时间前使用缓存，不需要请求。受限于本地时间，如果本地时间修改，可能造成缓存失效

2. cache-control
控制网页缓存 如Cache-Control:max-age=300时，则代表在这个请求正确返回时间（浏览器也会记录下来）的5分钟内再次加载资源，就会命中强缓存
+ public：所有内容都将被缓存（客户端和代理服务器都可缓存）
+ private:所有内容只有客户端可以缓存
+ no-cache:表示不使用 Cache-Control的缓存控制方式做前置验证，而是使用 Etag 或者Last-Modified字段来控制缓存
+ no-store：所有内容都不会被缓存，即不使用强制缓存，也不使用协商缓存
+ max-age:缓存内容多久后失效
+ max-stale：能容忍的最大过期时间
+ s-maxage（单位为s)：同max-age作用一样，只在代理服务器中生效（比如CDN缓存）
+ min-fresh：能够容忍的最小新鲜度

### 协商缓存
强缓存失效后，浏览器携带缓存标识向服务器发起请求，由服务器根据缓存标识决定是否用缓存的过程

+ 协商缓存生效返回 304和node modified
+ 协商缓存失效返回 200和请求结果

通过 Last-Modified 和 ETag  实现

1. Last-Modified和If-Modified-Since
浏览器第一次发送请求，服务器返回资源时将这个资源的最后修改时间添加到Last-Modified,浏览器接收后缓存。浏览器再次请求时检测到Last-Modified，将Last-Modified的值添加到If-Modified-Since返回给服务端，服务端根据这个值去对比当前资源的最后修改时间，没变化返回304 从缓存中取，如果If-Modified-Since的时间小于服务器中这个资源的最后修改时间，说明文件有更新，于是返回新的资源文件和200

存在问题：
+ 本地打开缓存文件就会导致Last-Modified，发送相同资源
+ Last-Modified只能以秒计时

2. ETag和If-None-Match
Etag是服务器响应请求时，返回当前资源文件的一个唯一标识(由服务器生成)，只要资源有变化，Etag就会重新生成。
原理类似   浏览器再次请求时将Etag放在If-None-Match返回到服务端 服务端匹配

### 缓存机制
强制缓存优先于协商缓存进行，若强制缓存(Expires和Cache-Control)生效则直接使用缓存，若不生效则进行协商缓存(Last-Modified / If-Modified-Since和Etag / If-None-Match)，协商缓存由服务器决定是否使用缓存，若协商缓存失效，那么代表该请求的缓存失效，返回200，重新返回资源和缓存标识，再存入浏览器缓存中；生效则返回304，继续使用缓存

### 用户行为对浏览器缓存的影响
+ 地址栏输入url:查找dish cache中是否有匹配
+ 普通刷新：Tab没关闭 可使用memory cache 其次dish cache
+ 强刷：浏览器不适用缓存

<-- https://juejin.cn/post/6844903757872889870 -->


